{"version":3,"names":["popoverMediaUploaderCss","PopoverMediaUploaderStyle0","PopoverMediaUploader","this","inProgress","urls","uploadProgressHandler","event","uploadingProgress","detail","state","uploadingId","url","checkCompleted","Object","keys","forEach","id","uploadProgress","updateView","popoverController","dismiss","uploadMedia","progress","componentDidLoad","files","size","file","cancel","progressId","media","StorageService","uploadFile","collectionId","itemId","render","h","key","color","Environment","getAppColor","TranslationService","getTransl","map","title","undefined","value","expand","fill","onClick"],"sources":["src/components/common/popovers/popover-media-uploader/popover-media-uploader.scss?tag=popover-media-uploader","src/components/common/popovers/popover-media-uploader/popover-media-uploader.tsx"],"sourcesContent":["popover-media-uploader {\n}\n","import {popoverController} from \"@ionic/core\";\nimport {Component, h, Listen, Prop, State} from \"@stencil/core\";\nimport {Media} from \"../../../../interfaces/common/media/media\";\nimport {Environment} from \"../../../../global/env\";\nimport {StorageService} from \"../../../../services/common/storage\";\nimport {UploadProgressData} from \"../../../../interfaces/interfaces\";\nimport {TranslationService} from \"../../../../services/common/translations\";\n\n@Component({\n  tag: \"popover-media-uploader\",\n  styleUrl: \"popover-media-uploader.scss\",\n})\nexport class PopoverMediaUploader {\n  @Prop() files: {\n    [id: string]: {\n      media: Media;\n      file: File;\n    };\n  };\n  @Prop() collectionId: string;\n  @Prop() itemId: string;\n\n  inProgress: {\n    [id: string]: {\n      size: number;\n      uploadProgress: number;\n    };\n  } = {};\n\n  @State() updateView = false;\n\n  urls: {\n    [id: string]: string;\n  } = {};\n\n  uploadingId: string;\n\n  @Listen(\"uploadProgress\", {target: \"window\", capture: true})\n  uploadProgressHandler(event: CustomEvent<UploadProgressData>) {\n    const uploadingProgress: UploadProgressData = event.detail;\n    if (uploadingProgress.state === \"completed\") {\n      this.urls[this.uploadingId] = uploadingProgress.url;\n      let checkCompleted = true;\n      Object.keys(this.inProgress).forEach((id) => {\n        checkCompleted =\n          checkCompleted && this.inProgress[id].uploadProgress === 100;\n      });\n      this.updateView = !this.updateView;\n      if (checkCompleted) {\n        //all files downloaded\n        popoverController.dismiss(this.urls);\n      } else {\n        //download next file\n        this.uploadMedia();\n      }\n    } else if (uploadingProgress.state === \"error\") {\n      popoverController.dismiss(false);\n    } else {\n      this.inProgress[this.uploadingId].uploadProgress =\n        uploadingProgress.progress;\n      this.updateView = !this.updateView;\n    }\n  }\n\n  componentDidLoad() {\n    this.inProgress = {};\n    Object.keys(this.files).forEach((id) => {\n      //set all to false to start download\n      this.inProgress[id] = {\n        size: this.files[id].file.size,\n        uploadProgress: 0,\n      };\n    });\n    this.uploadMedia();\n  }\n  async cancel() {\n    popoverController.dismiss(false);\n  }\n\n  uploadMedia() {\n    //check media that have not completed download and start download\n    let id = null;\n    Object.keys(this.inProgress).forEach((progressId) => {\n      if (this.inProgress[progressId].uploadProgress == 0) {\n        id = progressId;\n        return;\n      }\n    });\n    this.uploadingId = id;\n    const file = this.files[id].file;\n    const media = this.files[id].media;\n    StorageService.uploadFile(this.collectionId, this.itemId, media, file);\n  }\n\n  render() {\n    return [\n      <ion-header>\n        <ion-toolbar color={Environment.getAppColor()}>\n          <ion-title>\n            {TranslationService.getTransl(\"media-uploader\", \"Media Uploader\")}\n          </ion-title>\n        </ion-toolbar>\n      </ion-header>,\n      <ion-content>\n        <ion-list>\n          {Object.keys(this.files).map((id) => [\n            <ion-item>\n              <ion-label>\n                <h4>{this.files[id].media.title}</h4>\n                {this.inProgress && this.inProgress[id]\n                  ? [\n                      <h5>\n                        {TranslationService.getTransl(\"file-size\", \"File Size\")}\n                        : {this.inProgress[id].size}\n                      </h5>,\n                      <p>\n                        {TranslationService.getTransl(\"uploaded\", \"Uploaded\")}:{\" \"}\n                        {this.inProgress[id].uploadProgress}%\n                      </p>,\n                    ]\n                  : undefined}\n              </ion-label>\n            </ion-item>,\n            this.inProgress && this.inProgress[id] ? (\n              <ion-progress-bar value={this.inProgress[id].uploadProgress} />\n            ) : undefined,\n          ])}\n        </ion-list>\n        <ion-button expand=\"block\" fill=\"outline\" onClick={() => this.cancel()}>\n          <ion-label>\n            {TranslationService.getTransl(\"cancel\", \"Cancel\")}\n          </ion-label>\n        </ion-button>\n      </ion-content>,\n    ];\n  }\n}\n"],"mappings":"yVAAA,MAAMA,EAA0B,GAChC,MAAAC,EAAeD,E,MCWFE,EAAoB,M,yBAU/BC,KAAAC,WAKI,GAIJD,KAAAE,KAEI,G,uFAJkB,K,CAStB,qBAAAC,CAAsBC,GACpB,MAAMC,EAAwCD,EAAME,OACpD,GAAID,EAAkBE,QAAU,YAAa,CAC3CP,KAAKE,KAAKF,KAAKQ,aAAeH,EAAkBI,IAChD,IAAIC,EAAiB,KACrBC,OAAOC,KAAKZ,KAAKC,YAAYY,SAASC,IACpCJ,EACEA,GAAkBV,KAAKC,WAAWa,GAAIC,iBAAmB,GAAG,IAEhEf,KAAKgB,YAAchB,KAAKgB,WACxB,GAAIN,EAAgB,CAElBO,EAAkBC,QAAQlB,KAAKE,K,KAC1B,CAELF,KAAKmB,a,OAEF,GAAId,EAAkBE,QAAU,QAAS,CAC9CU,EAAkBC,QAAQ,M,KACrB,CACLlB,KAAKC,WAAWD,KAAKQ,aAAaO,eAChCV,EAAkBe,SACpBpB,KAAKgB,YAAchB,KAAKgB,U,EAI5B,gBAAAK,GACErB,KAAKC,WAAa,GAClBU,OAAOC,KAAKZ,KAAKsB,OAAOT,SAASC,IAE/Bd,KAAKC,WAAWa,GAAM,CACpBS,KAAMvB,KAAKsB,MAAMR,GAAIU,KAAKD,KAC1BR,eAAgB,EACjB,IAEHf,KAAKmB,a,CAEP,YAAMM,GACJR,EAAkBC,QAAQ,M,CAG5B,WAAAC,GAEE,IAAIL,EAAK,KACTH,OAAOC,KAAKZ,KAAKC,YAAYY,SAASa,IACpC,GAAI1B,KAAKC,WAAWyB,GAAYX,gBAAkB,EAAG,CACnDD,EAAKY,EACL,M,KAGJ1B,KAAKQ,YAAcM,EACnB,MAAMU,EAAOxB,KAAKsB,MAAMR,GAAIU,KAC5B,MAAMG,EAAQ3B,KAAKsB,MAAMR,GAAIa,MAC7BC,EAAeC,WAAW7B,KAAK8B,aAAc9B,KAAK+B,OAAQJ,EAAOH,E,CAGnE,MAAAQ,GACE,MAAO,CACLC,EAAA,cAAAC,IAAA,4CACED,EAAA,eAAAC,IAAA,2CAAaC,MAAOC,EAAYC,eAC9BJ,EAAA,aAAAC,IAAA,4CACGI,EAAmBC,UAAU,iBAAkB,qBAItDN,EAAA,eAAAC,IAAA,4CACED,EAAA,YAAAC,IAAA,4CACGvB,OAAOC,KAAKZ,KAAKsB,OAAOkB,KAAK1B,GAAO,CACnCmB,EAAA,gBACEA,EAAA,iBACEA,EAAA,UAAKjC,KAAKsB,MAAMR,GAAIa,MAAMc,OACzBzC,KAAKC,YAAcD,KAAKC,WAAWa,GAChC,CACEmB,EAAA,UACGK,EAAmBC,UAAU,YAAa,aAAY,KACpDvC,KAAKC,WAAWa,GAAIS,MAEzBU,EAAA,SACGK,EAAmBC,UAAU,WAAY,YAAW,IAAG,IACvDvC,KAAKC,WAAWa,GAAIC,eAAc,MAGvC2B,YAGR1C,KAAKC,YAAcD,KAAKC,WAAWa,GACjCmB,EAAA,oBAAkBU,MAAO3C,KAAKC,WAAWa,GAAIC,iBAC3C2B,cAGRT,EAAA,cAAAC,IAAA,2CAAYU,OAAO,QAAQC,KAAK,UAAUC,QAAS,IAAM9C,KAAKyB,UAC5DQ,EAAA,aAAAC,IAAA,4CACGI,EAAmBC,UAAU,SAAU,a","ignoreList":[]}