import{r as e,h as t,H as a,f as i}from"./p-cbe60c68.js";import"./p-c7ee7cfe.js";import{m as o,n}from"./p-c2915cc5.js";import{S as s}from"./p-a75993af.js";import{U as c,p as d,W as l,a0 as r,a1 as f,T as b,a2 as h,R as u,a3 as m,a4 as p,a5 as y,S as k,E as C,C as w}from"./p-6934ed3c.js";import{l as g}from"./p-1af05547.js";import"./p-3647f076.js";import"./p-9c77ce6f.js";import"./p-c11a967f.js";import"./p-694b8ade.js";import"./p-ae1763fb.js";import"./p-c5936999.js";import"./p-6879854f.js";import"./p-e9c4f463.js";const v="modal-customer-update ion-list{width:100%}";const x=v;const L=class{constructor(t){e(this,t);this.saveNewOwner=false;this.titles=[{tag:"information",text:"Information",disabled:false},{tag:"locations",text:"Locations",disabled:false},{tag:"operating-conditions",text:"Operating Conditions",disabled:false}];this.customerId=undefined;this.customer=undefined;this.updateView=true;this.validCustomer=false;this.locationTypeSegment="add";this.slider=undefined}async componentWillLoad(){this.userProfileSub$=c.userProfile$.subscribe((e=>{this.userProfile=new d(e)}));await this.loadCustomer()}async loadCustomer(){if(this.customerId){const e=await l.getCustomer(this.customerId);this.customer=e;if(this.customer.locations.length>0)this.locationTypeSegment=0}else{this.customer=new r;this.customer.users={[c.userRoles.uid]:["owner"]}}}async componentDidLoad(){this.slider=new s(".slider-edit-customer",{speed:400,spaceBetween:100,allowTouchMove:false,autoHeight:true});this.setTypesSelect();this.validateCustomer()}disconnectedCallback(){this.userProfileSub$.unsubscribe()}handleChange(e){this.customer[e.detail.name]=e.detail.value;this.validateCustomer()}handleInformationChange(){this.validateCustomer()}updateParam(){this.validateCustomer()}updateImageUrls(e){const t=e.detail.type;const a=e.detail.url;if(t=="photo"){this.customer.photoURL=a}else{this.customer.coverURL=a}this.save(false)}validateCustomer(){let e=true;this.customer.locations.forEach((t=>{if(t&&t.position)e=e&&g.exports.isNumber(t.position.geopoint.latitude)&&g.exports.isNumber(t.position.geopoint.longitude)}));this.validCustomer=e&&g.exports.isString(this.customer.fullName)&&this.customer.typeId!=null}addLocation(){this.customer.locations.push(new f);this.locationTypeSegment=this.customer.locations.length-1;this.updateSlider()}updateLocation(){this.updateSlider()}deleteLocation(e){this.customer.locations.splice(e,1);this.updateSlider()}setTypesSelect(){const e=this.el.querySelector("#selectType");const t={header:b.getTransl("customer_type","Customer Type")};e.interfaceOptions=t;const a=Array.from(e.getElementsByTagName("ion-select-option"));a.map((t=>{e.removeChild(t)}));e.placeholder=b.getTransl("select","Select");l.getCustomerTypes().map((t=>{const a=document.createElement("ion-select-option");a.value=t.typeId;a.textContent=b.getTransl(t.typeId,t.typeName);e.appendChild(a)}))}selectType(e){this.customer.typeId=e.detail.value;this.validateCustomer()}locationTypeSegmentChanged(e){if(e.detail.value!=="add"){this.locationTypeSegment=e.detail.value;this.updateView=!this.updateView;this.updateSlider()}}selectOwner(e){this.customer.owner=e.detail.value;this.validateCustomer()}selectGroupOwner(e,t){this.customer.group[t]=e.detail.value;this.validateCustomer()}async editOwner(e,t,a){let i=new h;if(e){if(t>=0){i=this.customer.group[t];if(a){this.customer.group.splice(t,1)}}}else{i=this.customer.owner}if(!a){const a=await o.create({component:"popover-edit-customer-owner",translucent:true,componentProps:{owner:i,group:e}});a.onDidDismiss().then((async a=>{const i=a.data;if(i){if(e){if(t>=0){this.customer.group[t]=i.owner}else{this.customer.group.push(i.owner)}}else{this.customer.owner=i.owner}this.saveNewOwner=i.new;this.updateSlider()}}));a.present()}this.updateSlider()}updateSlider(){this.updateView=!this.updateView;setTimeout((()=>{this.slider?this.slider.update():undefined}),100)}async editOperatingCondition(e,t){const a=await u.openModal("modal-operating-conditions-questionnaire",{condition:e,conditionData:g.exports.cloneDeep(t),editable:true});a.onDidDismiss().then((a=>{a=a.data;if(a&&t){if(e=="EAF")t=new m(a);else if(e=="LF")t=new p(a);else if(e=="CCM")t=new y(a);this.updateSlider()}else if(a){if(e=="EAF")this.customer.conditions.EAF.push(new m(a));else if(e=="LF")this.customer.conditions.LF.push(new p(a));else if(e=="CCM")this.customer.conditions.CCM.push(new y(a));this.updateSlider()}}))}async deleteCustomer(){try{await l.deleteCustomer(this.customerId);n.dismiss()}catch(e){if(e)k.presentAlertError(e)}}async save(e=true){const t=await l.updateCustomer(this.customerId,this.customer,this.userProfile.uid);if(this.customerId){return e?n.dismiss():true}else{this.customerId=t.id;return true}}async cancel(){n.dismiss()}render(){return t(a,{key:"15b56af52db3c26133de8e25a3ab5d163bee2cbc"},t("ion-header",{key:"281284794826a14ae71d147aecbf3e64211fcc9c"},t("app-upload-cover",{key:"2df25b9e8f12b4f3d48061546860be73f2f74f87",item:{collection:w,id:this.customerId,photoURL:this.customer.photoURL,coverURL:this.customer.coverURL},onCoverUploaded:e=>this.updateImageUrls(e)})),t("app-header-segment-toolbar",{key:"8f136565682a8d54750becf80ce2204c10d09fc0",color:C.getAppColor(),swiper:this.slider,titles:this.titles}),t("ion-content",{key:"f556a4e7ae85da3fdb5372343e2912f4e203ea6c",class:"slides"},t("swiper-container",{key:"8c04ba573fa9fdb66189e44c0716e410774cfb71",class:"slider-edit-customer swiper"},t("swiper-wrapper",{key:"b0ee238b2d18bae79bd7985861e602d41f5aaff1",class:"swiper-wrapper"},t("swiper-slide",{key:"b522ede8d45dce0dafe949d038ffacfbca573d1d",class:"swiper-slide"},t("ion-list",{key:"c48f749343bad3d137a22dd989cc51eb9a542e44",class:"ion-no-padding"},t("ion-item",{key:"4e7d2732078ff4830b9843b75947d2e013c87816",lines:"none"},t("ion-select",{key:"8754bbd848690f6c152050b94359c4804d25149f",color:"trasteel",id:"selectType",interface:"action-sheet",label:b.getTransl("customer_type","Customer Type"),"label-placement":"floating",onIonChange:e=>this.selectType(e),value:this.customer&&this.customer.typeId?this.customer.typeId:null})),t("app-form-item",{key:"191855389d6a89c78f56b5794e1509ade8d40dd8","label-tag":"name","label-text":"Name",value:this.customer.fullName,name:"fullName","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"7b7dff220b71e733f484346cec941c288a6da566","label-tag":"local_name","label-text":"Local Name",value:this.customer.fullNameOther,name:"fullNameOther","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"e07e7796fc03e6de1ce770b8c18fac20af962e42",labelTag:"other_name",labelText:"Other Name",value:this.customer.otherPlantName,name:"otherPlantName","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"66f2b203faf2495f69a049ea1bbaf11a6eed58fb",labelTag:"other_name",labelText:"Other Local Name",value:this.customer.otherPlantNameOther,name:"otherPlantNameOther","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"0037efd6186698bde577392f423384d62316a885",labelTag:"short_name",labelText:"Short Name",value:this.customer.shortName,name:"shortName","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),this.customer.group.length==0?t("ion-item",{lines:"none"},t("ion-label",null,t("h2",null,t("my-transl",{tag:"add_customer_group",text:"Add Customer Group"}))),t("ion-button",{onClick:()=>this.editOwner(true),slot:"end"},"+")):undefined,this.customer.group.map(((e,a)=>t("ion-item",{lines:"none"},t("ion-label",null,a==0?t("ion-note",null,t("my-transl",{tag:"customer_group",text:"Customer Group"})):undefined,t("h2",null,e.groupName+" ["+e.groupOwnershipPerc+"%]")),a==this.customer.group.length-1?t("ion-button",{onClick:()=>this.editOwner(true),slot:"end"},"+"):undefined,t("ion-button",{slot:"end","icon-only":true,color:"danger",fill:"clear",onClick:()=>{this.editOwner(true,a,true)}},t("ion-icon",{name:"trash"})),t("ion-button",{slot:"end","icon-only":true,fill:"clear",onClick:()=>{this.editOwner(true,a)}},t("ion-icon",{name:"create"}))))),t("ion-item",{key:"88f8be631c372001bf8b4d94956ed4eb6b06a08e",lines:"none"},t("ion-label",{key:"f53c8e8c0f0045536bed009e81663bdb0b4d2cea"},t("ion-note",{key:"4ddab73e6b9f0d7dcfc656cb05ae1c58677ef1fc"},t("my-transl",{key:"eb3af2a42ebad11a47f83922e55c901ac853fa8b",tag:"customer_owner",text:"Customer Owner"})),t("h2",{key:"2573001474f3c6d11a96e212d5ebc91e6700d531"},this.customer.owner.groupName)),t("ion-button",{key:"52758bc1aef5fd83bc017711fd67613dc9f2e80f",slot:"end","icon-only":true,fill:"clear",onClick:()=>{this.editOwner(false)}},t("ion-icon",{key:"1f33799b96586c4f3fef8ca616406a908a9930b1",name:"create"}))),t("app-customer-plant-production",{key:"a12d406d4a37a831f02362cb34939a537f0f133b",customer:this.customer,editable:true})),this.customerId?t("ion-footer",{class:"ion-no-border"},t("ion-toolbar",null,t("ion-button",{expand:"block",fill:"outline",color:"danger",onClick:()=>this.deleteCustomer()},t("ion-icon",{slot:"start",name:"trash"}),t("my-transl",{tag:"delete",text:"Delete",isLabel:true})))):undefined),t("swiper-slide",{key:"65c5c4e652b0b05d4448e127e512d589bb06f08e",class:"swiper-slide"},t("div",{key:"0f968dd3625d2f1abf1c8ddea8a8dcf52c4ac17b"},t("ion-toolbar",{key:"2a778134b293c0324e1b779c55e59ae36b542643"},t("ion-segment",{key:"3d8097b4bbb6dd6f97a49174619bfd7bbbedc413",mode:"ios",scrollable:true,onIonChange:e=>this.locationTypeSegmentChanged(e),value:this.locationTypeSegment},this.customer.locations.map(((e,a)=>t("ion-segment-button",{value:a,layout:"icon-start"},t("ion-label",null,l.getLocationsTypes(e.type)[0].locationName)))),t("ion-segment-button",{key:"7b40939d249b490a4a7caabfb0a938988b60e7f5",value:"add",onClick:()=>this.addLocation(),layout:"icon-start"},t("ion-label",{key:"0cd325b6065d966c5158cb22340af062e006a4d6"},"+")))),this.customer.locations.map(((e,a)=>t("div",null,this.locationTypeSegment==a?t("div",null,t("app-location",{locations:l.getLocationsTypes(),location:e,slider:this.slider,onLocationSelected:()=>this.updateLocation(),onLocationDeleted:()=>this.deleteLocation(a)})):undefined))))),t("swiper-slide",{key:"210875435c5129803022bc0ea7faa978d97f8ba0",class:"swiper-slide"},t("ion-grid",{key:"43d7210bcae8f8e2b4773470b1566a554d6387f8"},t("ion-row",{key:"06f55d4495534dd94ae3f9a700a0f1439d11d168"},t("ion-col",{key:"740327d78c6dd81c0481fb1479f27ac0a540b260"},t("ion-button",{key:"76a85b68a6c03a83a2e460718d91858de56927a6",color:C.getAppColor(),onClick:()=>this.editOperatingCondition("EAF"),expand:"block"},t("ion-icon",{key:"4fd91df961c5bf0eb69f8183640a83eb967c8533",name:"add"}),t("ion-label",{key:"b68e451771ed125ff59f9854921d22d3ee798188"},"EAF"))),t("ion-col",{key:"a3f1d2a7bcc6398aedee331284a4b26e2037c754"},t("ion-button",{key:"b26e5a225da4a835d871b78725209e906c7d6ccb",color:C.getAppColor(),onClick:()=>this.editOperatingCondition("LF"),expand:"block"},t("ion-icon",{key:"0ddbe3c69644fe6c40f1afb5fceab4fdfa87256a",name:"add"}),t("ion-label",{key:"5f18d93bccebbc9c208e03739e2968c62a90a3d1"},"LF"))),t("ion-col",{key:"b0a9ee96c89c4d48407e34983f5b9570f3cc4de1"},t("ion-button",{key:"b84e0981a6bbedcaaabdb689900bc7fd201fb5cb",color:C.getAppColor(),onClick:()=>this.editOperatingCondition("CCM"),expand:"block"},t("ion-icon",{key:"2b4f2e72a988d26e1bc2db8be4138f85407dc38b",name:"add"}),t("ion-label",{key:"78a5fe07658b70726be470070498346424c745da"},"CCM"))))),t("ion-list",{key:"aa6191698b1514663d7922969cf546b52ce2136c"},t("ion-item-divider",{key:"f1ec41c808c5c2d2decf1fecac439f488d6a1868"},"EAF"),this.customer.conditions.EAF.map((e=>t("ion-item",{button:true,detail:true,onClick:()=>this.editOperatingCondition("EAF",e)},t("ion-label",null,new Date(e.date).toLocaleDateString())))),t("ion-item-divider",{key:"a2c9027cb21c2dc983c3faae4f933f27f3aa3f94"},"LF"),this.customer.conditions.LF.map((e=>t("ion-item",{button:true,detail:true,onClick:()=>this.editOperatingCondition("EAF",e)},t("ion-label",null,new Date(e.date).toLocaleDateString())))),t("ion-item-divider",{key:"e437cc9cb0192eb108a7c4386b5911590ce249db"},"CCM"),this.customer.conditions.CCM.map((e=>t("ion-item",null,t("ion-label",null,new Date(e.date).toLocaleDateString()))))))))),t("app-modal-footer",{key:"16fb006575393ead0fa588dfd58a71a9932cec63",color:C.getAppColor(),disableSave:!this.validCustomer,onCancelEmit:()=>this.cancel(),onSaveEmit:()=>this.save()}))}get el(){return i(this)}};L.style=x;export{L as modal_customer_update};