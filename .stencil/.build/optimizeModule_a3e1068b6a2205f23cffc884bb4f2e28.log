import{r as t,h as e,H as a}from"./p-cbe60c68.js";import{aT as s,T as i,R as o,U as n,y as c}from"./p-773bd3de.js";import"./p-c7ee7cfe.js";import{m as r,b as d}from"./p-c2915cc5.js";import{l as p}from"./p-1af05547.js";import"./p-694b8ade.js";import"./p-e9c4f463.js";import"./p-3647f076.js";import"./p-9c77ce6f.js";import"./p-c11a967f.js";import"./p-ae1763fb.js";import"./p-c5936999.js";import"./p-6879854f.js";const h='app-chat{width:100%;height:var(--chatHeight)}app-chat #chat-container{--padding-bottom:65px}app-chat .chat-footer{position:absolute;bottom:0 !important;width:100%}app-chat .messages{padding-left:20px;padding-right:20px;margin-bottom:20px;display:flex;flex-direction:column}app-chat .message{border-radius:20px;padding:8px 15px;margin-top:5px;margin-bottom:5px;display:inline-block}app-chat .system{align-items:center;display:flex;flex-direction:column}app-chat .system .message{color:rgb(68, 68, 68);padding:0;margin-top:5px;margin-bottom:1px;font-size:smaller}app-chat .yours{align-items:flex-start}app-chat .yours .sendername{color:rgb(201, 201, 201);font-size:smaller}app-chat .yours .message{margin-right:25%;background:linear-gradient(to bottom, #eee 0%, rgb(212, 212, 212) 100%);background-attachment:fixed;position:relative}app-chat .yours .message.last:before{content:"";position:absolute;z-index:0;bottom:0;left:-7px;height:20px;width:20px;background:linear-gradient(to bottom, #eee 0%, rgb(212, 212, 212) 100%);background-attachment:fixed;border-bottom-right-radius:15px}app-chat .yours .message.last:after{content:"";position:absolute;z-index:1;bottom:0;left:-10px;width:10px;height:20px;background:white;border-bottom-right-radius:10px}app-chat .mine{align-items:flex-end}app-chat .mine .timestamp{color:#00d0ea;font-size:smaller}app-chat .mine .message{color:white;margin-left:25%;background:linear-gradient(to bottom, #00d0ea 0%, #0085d1 100%);background-attachment:fixed;position:relative}app-chat .mine .message.last:before{content:"";position:absolute;z-index:0;bottom:0;right:-8px;height:20px;width:20px;background:linear-gradient(to bottom, #00d0ea 0%, #0085d1 100%);background-attachment:fixed;border-bottom-left-radius:15px}app-chat .mine .message.last:after{content:"";position:absolute;z-index:1;bottom:0;right:-10px;width:10px;height:20px;background:white;border-bottom-left-radius:10px}';const l=h;const m=class{constructor(e){t(this,e);this.showingPopover=false;this.chatId=undefined;this.messageGroups=[];this.message=undefined;this.sendingMessage=false}async addParticipants(t){if(!this.showingPopover){this.showingPopover=true;const e=await r.create({component:"popover-chat-participants",componentProps:{chat:this.chat},event:t,translucent:true});e.onDidDismiss().then((async t=>{if(t&&t.data){const e=t.data;s.updateParticipants(this.chatId,this.chat,e)}else{if(Object.keys(this.chat.participants).length<=1){const t=await d.create({header:i.getTransl("chat","Chat"),message:i.getTransl("chat-participants-error","You should add at least another participant to the chat."),buttons:[{text:i.getTransl("cancel","Cancel"),role:"cancel",handler:async()=>{o.push("/chat","root")}},{text:i.getTransl("ok","OK"),handler:async()=>{this.addParticipants(null)}}]});t.present()}}this.showingPopover=false}));e.present()}}componentWillLoad(){this.chatSub=s.loadedChat$.subscribe((t=>{if(t&&t.participants){this.chat=t;this.updateMessagesArrayArray();if(Object.keys(this.chat.participants).length==1){this.addParticipants(null)}}}));s.loadChatsForUser(n.userProfile.uid);s.loadChat(this.chatId)}componentDidLoad(){this.chatContainer=document.getElementById("chat-container");this.scrollToBottom()}disconnectedCallback(){s.saveLastChatReadToUser(this.chatId,this.chat);this.chatSub.unsubscribe();s.unloadChat()}scrollToBottom(){setTimeout((()=>{this.chatContainer.scrollToBottom()}),100)}updateMessagesArrayArray(){this.messageGroups=[];let t=null;let e=null;let a=null;let o=null;let n=-1;const r=p.exports.orderBy(this.chat.thread,"created");for(let d=0;d<r.length;d++){const h=r[d];t=h.senderId;o=d==r.length-1?null:r[d+1].senderId;let l=e==null||e!=t;let m=t==s.chatUser.id;let f=t!=o;let b=h.senderId=="system";const u={content:h.content+(b?h.senderName=="added"?" "+i.getTransl("is-in","is in"):" "+i.getTransl("is-out","is out"):""),created:h.created,isFirst:l,isLast:f,senderName:h.senderName};if(l){const t=c.fromUnixTime(p.exports.toNumber(h.created));const e=a?c.differenceInMinutes(a,t)>=10:true;if(!b&&e){const e=c.differenceInDays(new Date,t)>=1?c.format(t,"PPPP"):`${c.format(t,"EEEE")} ${c.format(t,"p")}`;this.messageGroups.push({isSystem:true,messages:[{content:e}]});a=t;n++}n++;const s={isMine:m,isSystem:b,messages:[u]};this.messageGroups.push(s)}else{this.messageGroups[n].messages.push(u)}e=h.senderId}this.sendingMessage=false;this.scrollToBottom()}handleChange(t){this.message=t.target.value}handleKey(t){if(t.code==="Enter"){event.preventDefault();this.sendMessage()}}sendMessage(){this.sendingMessage=true;const t=this.message;this.message="";s.sendChatMessage(this.chatId,this.chat,t)}render(){return e(a,{key:"a5efd54b4c6a5840627cf3ab53b775ed51cbcd22"},e("ion-content",{key:"617d2acd74bdf5fa52b6c9d307f950b369d488a8",id:"chat-container"},this.messageGroups.map((t=>[e("div",{class:t.isMine?"mine messages":t.isSystem?"system":"yours messages"},t.messages.map((a=>[this.chat&&this.chat.participants&&Object.keys(this.chat.participants).length>2&&!t.isMine&&a.isFirst&&!t.isSystem?e("div",{class:"sendername"},a.senderName):undefined,e("div",{class:"message"+(a.isLast?" last":""),innerHTML:a.content})])))]))),e("ion-footer",{key:"b02a60ece9f777385a17d696a7f210fe910156de",class:"chat-footer"},e("ion-toolbar",{key:"c4352a775be267d90c58e695962d03a551f54224"},e("ion-item",{key:"1062f41b6dd464e00dc0abb6291c3f0a775b554d",lines:"none"},this.sendingMessage?e("ion-spinner",{name:"dots"}):undefined,e("ion-input",{key:"debbe8efc69022d95a3b9a3049dc71f18b2f5f3c",mode:"ios",placeholder:!this.sendingMessage?i.getTransl("write-message","Write a message"):undefined,autofocus:true,clearOnEdit:true,value:this.message,disabled:this.sendingMessage,onIonInput:t=>this.handleChange(t),onKeyUp:t=>this.handleKey(t)}),e("ion-button",{key:"680d96fec214c1053c8c928a5a3af424e5f6c684",slot:"end","icon-only":true,fill:"clear",disabled:this.sendingMessage,onClick:()=>this.sendMessage()},e("ion-icon",{key:"e4d0946025e8df4ee8dec8b76c41f60a39c8e99b",name:"paper-plane-outline"}))))))}};m.style=l;export{m as app_chat};