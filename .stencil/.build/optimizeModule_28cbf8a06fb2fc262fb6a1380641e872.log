import{r as t,h as s}from"./p-cbe60c68.js";import{aT as i,U as e,E as n,c as o,e as a,g as h,y as l}from"./p-26083a07.js";import{l as c}from"./p-1af05547.js";import"./p-c7ee7cfe.js";import"./p-694b8ade.js";import"./p-c2915cc5.js";import"./p-3647f076.js";import"./p-9c77ce6f.js";import"./p-c11a967f.js";import"./p-ae1763fb.js";import"./p-c5936999.js";import"./p-6879854f.js";import"./p-e9c4f463.js";const p="app-admin-chats{}";const r=p;const d=class{constructor(s){t(this,s);this.userPublicProfilesList=[];this.divingCentersList=[];this.divingSchoolsList=[];this.serviceCentersList=[];this.filterByOrganisierId=undefined;this.filterByChats=undefined;this.adminChatsArray=[];this.updateView=false;this.creatingNewChat=false;this.loadingChats=true;this.editingChat=""}async componentWillLoad(){this.loadingChats$=i.creatingNewChat$.subscribe((t=>{this.creatingNewChat=t}));this.editingChat$=i.editingChatId$.subscribe((t=>{this.editingChat=t}));this.userRoles$=e.userRoles$.subscribe((t=>{this.userRoles=t;if(this.filterByOrganisierId&&!this.userChats$){this.userChats$=i.servicesChatsList$.subscribe((t=>{this.loadChats(t)}))}else if(!this.userChats$){this.userChats$=i.userChatsList$.subscribe((t=>{this.loadChats(t)}))}this.filter()}));this.userPublicProfilesList$=e.userPublicProfilesList$.subscribe((t=>{this.userPublicProfilesList=t;this.filter()}));if(n.isUdive()){this.divingCentersList$=o.divingCentersList$.subscribe((t=>{this.divingCentersList=t;this.filter()}));this.divingSchoolsList$=a.divingSchoolsList$.subscribe((t=>{this.divingSchoolsList=t;this.filter()}));this.serviceCentersList$=h.serviceCentersList$.subscribe((t=>{this.serviceCentersList=t;this.filter()}))}}disconnectedCallback(){this.userRoles$.unsubscribe();this.userChats$.unsubscribe();this.userPublicProfilesList$.unsubscribe();this.editingChat$.unsubscribe();this.loadingChats$.unsubscribe();if(n.isUdive()){this.divingCentersList$.unsubscribe();this.divingSchoolsList$.unsubscribe();this.serviceCentersList$.unsubscribe()}}loadChats(t){i.resetSkeletons();this.loadingChats=false;if(t){let s=[];Object.keys(t).forEach((i=>{let e=t[i];e.id=i;s.push(e)}));s=c.exports.orderBy(s,"lastMessage.created","desc");this.adminChatsArray=s;this.filter()}}async filter(){if(this.adminChatsArray.length>0){this.adminChatsArray.map((async t=>{const s=t.organiser;s.item=await e.getOrganiser("item",s);if(n.isUdive()){t.owner=t.organiser.id===e.userProfile.uid||t.organiser.id===a.selectedDivingSchoolId||t.organiser.id===o.selectedDivingCenterId||t.organiser.id===h.selectedServiceCenterId||t.organiser.id===h.selectedServiceCenterId}t.participantNames=i.getOtherChatParticipants("names",t);t.photoURL=t.organiser&&t.organiser.item&&t.organiser.item.photoURL?t.organiser.item.photoURL:null;const l=i.getOtherChatParticipants("list",t);if(l.length==1){const s=l[0];let i=await e.getOrganiser("item",s);if(i&&i.photoURL)t.photoURL=i.photoURL}const p=e.userSettings.chatsLastRead&&e.userSettings.chatsLastRead[t.id]?e.userSettings.chatsLastRead[t.id]:false;t.unread=p&&t.lastMessage?c.exports.toNumber(t.lastMessage.created)>c.exports.toNumber(e.userSettings.chatsLastRead[t.id]):true}));if(this.filterByChats){const t=Object.keys(this.filterByChats);this.adminChatsArray=this.adminChatsArray.filter((s=>t.includes(s.id)))}this.updateView=!this.updateView}}delete(t,s){t.stopPropagation();i.deleteChat(s)}render(){return s("ion-list",{key:"4cdabcd73a5b5dd075543311ef46f0d973d9f42c"},this.loadingChats?[s("app-skeletons",{skeleton:"chat"}),s("app-skeletons",{skeleton:"chat"}),s("app-skeletons",{skeleton:"chat"}),s("app-skeletons",{skeleton:"chat"}),s("app-skeletons",{skeleton:"chat"})]:undefined,this.creatingNewChat?s("app-skeletons",{skeleton:"chat"}):undefined,this.adminChatsArray.map((t=>this.editingChat==t.id?s("app-skeletons",{skeleton:"chat"}):s("ion-item",{button:true,onClick:()=>i.presentChat(t.id),detail:true},t.photoURL?s("ion-avatar",{slot:"start"},s("ion-img",{src:t.photoURL})):s("ion-icon",{slot:"start",name:"chatbubbles-outline"}),s("ion-label",null,s("h2",{style:t.unread?{fontWeight:"bold"}:undefined},t.name?t.name:t.participantNames?t.participantNames:""),t.name?s("p",null,t.participantNames):undefined,t.lastMessage?s("p",null,l.format(l.fromUnixTime(c.exports.toNumber(t.lastMessage.created)),"PPP")):undefined),t.unread?s("ion-icon",{slot:"start",color:"danger",name:"radio-button-on"}):undefined,t.owner?s("ion-button",{fill:"clear",color:"danger","icon-only":true,slot:"end",onClick:s=>this.delete(s,t.id)},s("ion-icon",{name:"trash",slot:"end"})):undefined))))}};d.style=r;export{d as app_admin_chats};