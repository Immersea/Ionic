import{r as e,h as t,H as a,f as i}from"./p-cbe60c68.js";import"./p-c7ee7cfe.js";import{n as o,o as n}from"./p-5d4a8e1f.js";import{S as s}from"./p-a75993af.js";import{U as c,n as d,F as l,L as r,T as f,O as b,R as h,S as m,C as u}from"./p-736235c6.js";import{P as p,a9 as y,aa as k,ab as C}from"./p-1819cfda.js";import{E as w}from"./p-46038295.js";import{l as g}from"./p-1af05547.js";import"./p-3647f076.js";import"./p-9c77ce6f.js";import"./p-694b8ade.js";import"./p-ae1763fb.js";import"./p-c5936999.js";import"./p-6879854f.js";import"./p-7ee16e8d.js";import"./p-e9c4f463.js";const v="modal-customer-update ion-list{width:100%}";const x=v;const L=class{constructor(t){e(this,t);this.saveNewOwner=false;this.titles=[{tag:"information",text:"Information",disabled:false},{tag:"locations",text:"Locations",disabled:false},{tag:"operating-conditions",text:"Operating Conditions",disabled:false}];this.customerId=undefined;this.customer=undefined;this.updateView=true;this.validCustomer=false;this.locationTypeSegment="add";this.slider=undefined}async componentWillLoad(){this.userProfileSub$=c.userProfile$.subscribe((e=>{this.userProfile=new d(e)}));await this.loadCustomer()}async loadCustomer(){if(this.customerId){const e=await l.getCustomer(this.customerId);this.customer=e;if(this.customer.locations.length>0)this.locationTypeSegment=0}else{this.customer=new r;this.customer.users={[c.userRoles.uid]:["owner"]}}}async componentDidLoad(){this.slider=new s(".slider-edit-customer",{speed:400,spaceBetween:100,allowTouchMove:false,autoHeight:true});this.setTypesSelect();this.validateCustomer()}disconnectedCallback(){this.userProfileSub$.unsubscribe()}handleChange(e){this.customer[e.detail.name]=e.detail.value;this.validateCustomer()}handleInformationChange(){this.validateCustomer()}updateParam(){this.validateCustomer()}updateImageUrls(e){const t=e.detail.type;const a=e.detail.url;if(t=="photo"){this.customer.photoURL=a}else{this.customer.coverURL=a}this.save(false)}validateCustomer(){let e=true;this.customer.locations.forEach((t=>{if(t&&t.position)e=e&&g.exports.isNumber(t.position.geopoint.latitude)&&g.exports.isNumber(t.position.geopoint.longitude)}));this.validCustomer=e&&g.exports.isString(this.customer.fullName)&&this.customer.typeId!=null}addLocation(){this.customer.locations.push(new p);this.locationTypeSegment=this.customer.locations.length-1;this.updateSlider()}updateLocation(){this.updateSlider()}deleteLocation(e){this.customer.locations.splice(e,1);this.updateSlider()}setTypesSelect(){const e=this.el.querySelector("#selectType");const t={header:f.getTransl("customer_type","Customer Type")};e.interfaceOptions=t;const a=Array.from(e.getElementsByTagName("ion-select-option"));a.map((t=>{e.removeChild(t)}));e.placeholder=f.getTransl("select","Select");l.getCustomerTypes().map((t=>{const a=document.createElement("ion-select-option");a.value=t.typeId;a.textContent=f.getTransl(t.typeId,t.typeName);e.appendChild(a)}))}selectType(e){this.customer.typeId=e.detail.value;this.validateCustomer()}locationTypeSegmentChanged(e){if(e.detail.value!=="add"){this.locationTypeSegment=e.detail.value;this.updateView=!this.updateView;this.updateSlider()}}selectOwner(e){this.customer.owner=e.detail.value;this.validateCustomer()}selectGroupOwner(e,t){this.customer.group[t]=e.detail.value;this.validateCustomer()}async editOwner(e,t,a){let i=new b;if(e){if(t>=0){i=this.customer.group[t];if(a){this.customer.group.splice(t,1)}}}else{i=this.customer.owner}if(!a){const a=await o.create({component:"popover-edit-customer-owner",translucent:true,componentProps:{owner:i,group:e}});a.onDidDismiss().then((async a=>{const i=a.data;if(i){if(e){if(t>=0){this.customer.group[t]=i.owner}else{this.customer.group.push(i.owner)}}else{this.customer.owner=i.owner}this.saveNewOwner=i.new;this.updateSlider()}}));a.present()}this.updateSlider()}updateSlider(){this.updateView=!this.updateView;setTimeout((()=>{this.slider?this.slider.update():undefined}),100)}async editOperatingCondition(e,t){const a=await h.openModal("modal-operating-conditions-questionnaire",{condition:e,conditionData:g.exports.cloneDeep(t),editable:true});a.onDidDismiss().then((a=>{a=a.data;if(a&&t){if(e=="EAF")t=new y(a);else if(e=="LF")t=new k(a);else if(e=="CCM")t=new C(a);this.updateSlider()}else if(a){if(e=="EAF")this.customer.conditions.EAF.push(new y(a));else if(e=="LF")this.customer.conditions.LF.push(new k(a));else if(e=="CCM")this.customer.conditions.CCM.push(new C(a));this.updateSlider()}}))}async deleteCustomer(){try{await l.deleteCustomer(this.customerId);n.dismiss()}catch(e){if(e)m.presentAlertError(e)}}async save(e=true){const t=await l.updateCustomer(this.customerId,this.customer,this.userProfile.uid);if(this.customerId){return e?n.dismiss():true}else{this.customerId=t.id;return true}}async cancel(){n.dismiss()}render(){return t(a,{key:"4dc20b85c46bda9985cb715755919c232b1456e9"},t("ion-header",{key:"5b1b1637962a94bd51b7b09d2e4339a72b2cc1f2"},t("app-upload-cover",{key:"ac1648caf403520eb13a01bbb8ef50a52b440dc0",item:{collection:u,id:this.customerId,photoURL:this.customer.photoURL,coverURL:this.customer.coverURL},onCoverUploaded:e=>this.updateImageUrls(e)})),t("app-header-segment-toolbar",{key:"46343abd03791fdbc8a459a0e0e6a5842458a483",color:w.getAppColor(),swiper:this.slider,titles:this.titles}),t("ion-content",{key:"20257967dc02405a3c704329884ff085187aa054",class:"slides"},t("swiper-container",{key:"aef178617af0bbd2f78f3aba85eb6b76208931f5",class:"slider-edit-customer swiper"},t("swiper-wrapper",{key:"ef28b66f62073deb35ddaa517807b4a18aa1bf15",class:"swiper-wrapper"},t("swiper-slide",{key:"e7f2db78e272baabe6cbf4a06686143f64d6e35b",class:"swiper-slide"},t("ion-list",{key:"353407e1e6e843389f71f18cfc6e29b5bc590f5a",class:"ion-no-padding"},t("ion-item",{key:"d85f0f7f8b5d95163416d0fc25a44b2e31dbc2fc",lines:"none"},t("ion-select",{key:"0139c948052460f6442c1cb7b6871b102ab0d424",color:"trasteel",id:"selectType",interface:"action-sheet",label:f.getTransl("customer_type","Customer Type"),"label-placement":"floating",onIonChange:e=>this.selectType(e),value:this.customer&&this.customer.typeId?this.customer.typeId:null})),t("app-form-item",{key:"9a26fde233f5ab5a6bdda66763a85d1929abe6d7","label-tag":"name","label-text":"Name",value:this.customer.fullName,name:"fullName","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"8fe4117b77d72c40b93b354c0d7497ed647e16cf","label-tag":"local_name","label-text":"Local Name",value:this.customer.fullNameOther,name:"fullNameOther","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"fcaae1cdcadc395531a72d26df86038bb578482c",labelTag:"other_name",labelText:"Other Name",value:this.customer.otherPlantName,name:"otherPlantName","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"2893115d21a0c7d802835afd6699ff1a8602e475",labelTag:"other_name",labelText:"Other Local Name",value:this.customer.otherPlantNameOther,name:"otherPlantNameOther","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"d3d4c9863f6950650e8cbb5864d3bec329982686",labelTag:"short_name",labelText:"Short Name",value:this.customer.shortName,name:"shortName","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),this.customer.group.length==0?t("ion-item",{lines:"none"},t("ion-label",null,t("h2",null,t("my-transl",{tag:"add_customer_group",text:"Add Customer Group"}))),t("ion-button",{onClick:()=>this.editOwner(true),slot:"end"},"+")):undefined,this.customer.group.map(((e,a)=>t("ion-item",{lines:"none"},t("ion-label",null,a==0?t("ion-note",null,t("my-transl",{tag:"customer_group",text:"Customer Group"})):undefined,t("h2",null,e.groupName+" ["+e.groupOwnershipPerc+"%]")),a==this.customer.group.length-1?t("ion-button",{onClick:()=>this.editOwner(true),slot:"end"},"+"):undefined,t("ion-button",{slot:"end","icon-only":true,color:"danger",fill:"clear",onClick:()=>{this.editOwner(true,a,true)}},t("ion-icon",{name:"trash"})),t("ion-button",{slot:"end","icon-only":true,fill:"clear",onClick:()=>{this.editOwner(true,a)}},t("ion-icon",{name:"create"}))))),t("ion-item",{key:"f177ade98e62a00fce730f3d0ca81f701e63f88e",lines:"none"},t("ion-label",{key:"549bc245faa8ea3ae296ef65bb9abb2c4f25a3f4"},t("ion-note",{key:"500d9193337cd687eeb12c2a13c62ec768102a1f"},t("my-transl",{key:"e49217aaf7348e45e59587aa2bc2b9b2626f2de1",tag:"customer_owner",text:"Customer Owner"})),t("h2",{key:"c04cbc41f78796b4ab3c20c42509aef56a2074db"},this.customer.owner.groupName)),t("ion-button",{key:"cd00d4fef2922df8a0154f931ac08b6b588f340a",slot:"end","icon-only":true,fill:"clear",onClick:()=>{this.editOwner(false)}},t("ion-icon",{key:"b2b585cf205ddbc3fc427dcd37ba1aa6a1e882dc",name:"create"}))),t("app-customer-plant-production",{key:"09ad8b217c93976222e5920458765e906d2d08c1",customer:this.customer,editable:true})),this.customerId?t("ion-footer",{class:"ion-no-border"},t("ion-toolbar",null,t("ion-button",{expand:"block",fill:"outline",color:"danger",onClick:()=>this.deleteCustomer()},t("ion-icon",{slot:"start",name:"trash"}),t("my-transl",{tag:"delete",text:"Delete",isLabel:true})))):undefined),t("swiper-slide",{key:"c7dbfab03d5f98e87a8dc11c6a1160ba030d6919",class:"swiper-slide"},t("div",{key:"b282d7a8de0c1ef53125de3a2261fd8703a340dd"},t("ion-toolbar",{key:"9cd0c5f30b71e4f17887ab5692802a2c3f887c2b"},t("ion-segment",{key:"3eb0899adfe2d859043d87a5adcadb4273ee04d7",mode:"ios",scrollable:true,onIonChange:e=>this.locationTypeSegmentChanged(e),value:this.locationTypeSegment},this.customer.locations.map(((e,a)=>t("ion-segment-button",{value:a,layout:"icon-start"},t("ion-label",null,l.getLocationsTypes(e.type)[0].locationName)))),t("ion-segment-button",{key:"51279ea6430f3d5f04a96e0a56f58d8a7f7b286a",value:"add",onClick:()=>this.addLocation(),layout:"icon-start"},t("ion-label",{key:"c723131617c1e83a630d418734cc7354b5f756d0"},"+")))),this.customer.locations.map(((e,a)=>t("div",null,this.locationTypeSegment==a?t("div",null,t("app-location",{locations:l.getLocationsTypes(),location:e,slider:this.slider,onLocationSelected:()=>this.updateLocation(),onLocationDeleted:()=>this.deleteLocation(a)})):undefined))))),t("swiper-slide",{key:"3d67c02d3ee43be75a2e2484fbd9fcac26cb9df5",class:"swiper-slide"},t("ion-grid",{key:"f5018090c0a039e758f8d8bb660186b59e724091"},t("ion-row",{key:"25cfe758e6cebbe9e2a846bd9fdce0322f08727a"},t("ion-col",{key:"4a0c96d455e888072de1f7a417a98e79c1335ff3"},t("ion-button",{key:"ec9c186dc88da28ff8f3bbab6766bf4b6e537a94",color:w.getAppColor(),onClick:()=>this.editOperatingCondition("EAF"),expand:"block"},t("ion-icon",{key:"bc6508c28ea3b595074d54dde8a4fbac4943c2ec",name:"add"}),t("ion-label",{key:"d477925ae2f5ac4704846374b967cb6117a1b766"},"EAF"))),t("ion-col",{key:"db25af8a0bc33fe44539b308f6a0e6140df66ece"},t("ion-button",{key:"d4307588ad2d48765041f8703c03541c6f9ed36d",color:w.getAppColor(),onClick:()=>this.editOperatingCondition("LF"),expand:"block"},t("ion-icon",{key:"dc95d2e31e5209470db650f366459c78e76bf068",name:"add"}),t("ion-label",{key:"cfeeeec1ff35b89b00a3b0b82ef38d39d90607c5"},"LF"))),t("ion-col",{key:"c08ddda541382435e4addc2636a249c5668c4cd9"},t("ion-button",{key:"67f60b90bd8bd1f69864db128d2a756c4f010d18",color:w.getAppColor(),onClick:()=>this.editOperatingCondition("CCM"),expand:"block"},t("ion-icon",{key:"009a3b5bf859ce6e34e26589b5cb84ca715222f9",name:"add"}),t("ion-label",{key:"a2ede03cea341dbbdad53616919f602e83c8f458"},"CCM"))))),t("ion-list",{key:"f2208e3946847ce077c34d20bc91afb7eea77cf6"},t("ion-item-divider",{key:"30b3a911cfc5308c372b4b9d7c2dcd48e8e19e2c"},"EAF"),this.customer.conditions.EAF.map((e=>t("ion-item",{button:true,detail:true,onClick:()=>this.editOperatingCondition("EAF",e)},t("ion-label",null,new Date(e.date).toLocaleDateString())))),t("ion-item-divider",{key:"bf41d59d87ff075252bb04643ce973297a59c4a7"},"LF"),this.customer.conditions.LF.map((e=>t("ion-item",{button:true,detail:true,onClick:()=>this.editOperatingCondition("EAF",e)},t("ion-label",null,new Date(e.date).toLocaleDateString())))),t("ion-item-divider",{key:"6f272952373011a56308fadd484b0b074809cd6e"},"CCM"),this.customer.conditions.CCM.map((e=>t("ion-item",null,t("ion-label",null,new Date(e.date).toLocaleDateString()))))))))),t("app-modal-footer",{key:"cfb2812ec2c6014d6f9d676733e77e729dd57993",color:w.getAppColor(),disableSave:!this.validCustomer,onCancelEmit:()=>this.cancel(),onSaveEmit:()=>this.save()}))}get el(){return i(this)}};L.style=x;export{L as modal_customer_update};