import{r as e,h as t,H as a,f as i}from"./p-cbe60c68.js";import"./p-c7ee7cfe.js";import{m as o,n}from"./p-c2915cc5.js";import{S as s}from"./p-a75993af.js";import{U as c,n as d,W as l,a0 as r,a1 as b,T as f,a2 as h,R as u,a3 as m,a4 as p,a5 as y,S as k,E as C,C as w}from"./p-773bd3de.js";import{l as g}from"./p-1af05547.js";import"./p-3647f076.js";import"./p-9c77ce6f.js";import"./p-c11a967f.js";import"./p-694b8ade.js";import"./p-ae1763fb.js";import"./p-c5936999.js";import"./p-6879854f.js";import"./p-e9c4f463.js";const v="modal-customer-update ion-list{width:100%}";const x=v;const L=class{constructor(t){e(this,t);this.saveNewOwner=false;this.titles=[{tag:"information",text:"Information",disabled:false},{tag:"locations",text:"Locations",disabled:false},{tag:"operating-conditions",text:"Operating Conditions",disabled:false}];this.customerId=undefined;this.customer=undefined;this.updateView=true;this.validCustomer=false;this.locationTypeSegment="add";this.slider=undefined}async componentWillLoad(){this.userProfileSub$=c.userProfile$.subscribe((e=>{this.userProfile=new d(e)}));await this.loadCustomer()}async loadCustomer(){if(this.customerId){const e=await l.getCustomer(this.customerId);this.customer=e;if(this.customer.locations.length>0)this.locationTypeSegment=0}else{this.customer=new r;this.customer.users={[c.userRoles.uid]:["owner"]}}}async componentDidLoad(){this.slider=new s(".slider-edit-customer",{speed:400,spaceBetween:100,allowTouchMove:false,autoHeight:true});this.setTypesSelect();this.validateCustomer()}disconnectedCallback(){this.userProfileSub$.unsubscribe()}handleChange(e){this.customer[e.detail.name]=e.detail.value;this.validateCustomer()}handleInformationChange(){this.validateCustomer()}updateParam(){this.validateCustomer()}updateImageUrls(e){const t=e.detail.type;const a=e.detail.url;if(t=="photo"){this.customer.photoURL=a}else{this.customer.coverURL=a}this.save(false)}validateCustomer(){let e=true;this.customer.locations.forEach((t=>{if(t&&t.position)e=e&&g.exports.isNumber(t.position.geopoint.latitude)&&g.exports.isNumber(t.position.geopoint.longitude)}));this.validCustomer=e&&g.exports.isString(this.customer.fullName)&&this.customer.typeId!=null}addLocation(){this.customer.locations.push(new b);this.locationTypeSegment=this.customer.locations.length-1;this.updateSlider()}updateLocation(){this.updateSlider()}deleteLocation(e){this.customer.locations.splice(e,1);this.updateSlider()}setTypesSelect(){const e=this.el.querySelector("#selectType");const t={header:f.getTransl("customer_type","Customer Type")};e.interfaceOptions=t;const a=Array.from(e.getElementsByTagName("ion-select-option"));a.map((t=>{e.removeChild(t)}));e.placeholder=f.getTransl("select","Select");l.getCustomerTypes().map((t=>{const a=document.createElement("ion-select-option");a.value=t.typeId;a.textContent=f.getTransl(t.typeId,t.typeName);e.appendChild(a)}))}selectType(e){this.customer.typeId=e.detail.value;this.validateCustomer()}locationTypeSegmentChanged(e){if(e.detail.value!=="add"){this.locationTypeSegment=e.detail.value;this.updateView=!this.updateView;this.updateSlider()}}selectOwner(e){this.customer.owner=e.detail.value;this.validateCustomer()}selectGroupOwner(e,t){this.customer.group[t]=e.detail.value;this.validateCustomer()}async editOwner(e,t,a){let i=new h;if(e){if(t>=0){i=this.customer.group[t];if(a){this.customer.group.splice(t,1)}}}else{i=this.customer.owner}if(!a){const a=await o.create({component:"popover-edit-customer-owner",translucent:true,componentProps:{owner:i,group:e}});a.onDidDismiss().then((async a=>{const i=a.data;if(i){if(e){if(t>=0){this.customer.group[t]=i.owner}else{this.customer.group.push(i.owner)}}else{this.customer.owner=i.owner}this.saveNewOwner=i.new;this.updateSlider()}}));a.present()}this.updateSlider()}updateSlider(){this.updateView=!this.updateView;setTimeout((()=>{this.slider?this.slider.update():undefined}),100)}async editOperatingCondition(e,t){const a=await u.openModal("modal-operating-conditions-questionnaire",{condition:e,conditionData:g.exports.cloneDeep(t),editable:true});a.onDidDismiss().then((a=>{a=a.data;if(a&&t){if(e=="EAF")t=new m(a);else if(e=="LF")t=new p(a);else if(e=="CCM")t=new y(a);this.updateSlider()}else if(a){if(e=="EAF")this.customer.conditions.EAF.push(new m(a));else if(e=="LF")this.customer.conditions.LF.push(new p(a));else if(e=="CCM")this.customer.conditions.CCM.push(new y(a));this.updateSlider()}}))}async deleteCustomer(){try{await l.deleteCustomer(this.customerId);n.dismiss()}catch(e){if(e)k.presentAlertError(e)}}async save(e=true){const t=await l.updateCustomer(this.customerId,this.customer,this.userProfile.uid);if(this.customerId){return e?n.dismiss():true}else{this.customerId=t.id;return true}}async cancel(){n.dismiss()}render(){return t(a,{key:"6fe0e834d4d3aede464bdb86b110bd55bcde2a71"},t("ion-header",{key:"c83f603f8c34807879c9a2a073a0f7583e40f59a"},t("app-upload-cover",{key:"8fb7bcfd1ea614513e74560e579134a55069c190",item:{collection:w,id:this.customerId,photoURL:this.customer.photoURL,coverURL:this.customer.coverURL},onCoverUploaded:e=>this.updateImageUrls(e)})),t("app-header-segment-toolbar",{key:"3826b3e890444a26fe4ab9435a4926182056717b",color:C.getAppColor(),swiper:this.slider,titles:this.titles}),t("ion-content",{key:"cb0695d60888ec7943ab7f9e8297d57384f73eed",class:"slides"},t("swiper-container",{key:"0c1018bde63e5e7fb565d9aca858b03ec79c42a2",class:"slider-edit-customer swiper"},t("swiper-wrapper",{key:"45c32bba3c6e2092e355423763287b02def183c5",class:"swiper-wrapper"},t("swiper-slide",{key:"09cfd6b1a588e58590d444c3d032a8476aa06537",class:"swiper-slide"},t("ion-list",{key:"9df6d9c4542f1b1b858912d7c398edd6efe7f948",class:"ion-no-padding"},t("ion-item",{key:"a43accb6bf883c08e306c810576d58cc88475c57",lines:"none"},t("ion-select",{key:"abebd6652c26095ff4a40ac8831504eb7cfa76f0",color:"trasteel",id:"selectType",interface:"action-sheet",label:f.getTransl("customer_type","Customer Type"),"label-placement":"floating",onIonChange:e=>this.selectType(e),value:this.customer&&this.customer.typeId?this.customer.typeId:null})),t("app-form-item",{key:"1a7d978ef2f47acd4662a4704b80818e03322783","label-tag":"name","label-text":"Name",value:this.customer.fullName,name:"fullName","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"1943bc739a8847d9d2316765fa5b85a41ef0d24e","label-tag":"local_name","label-text":"Local Name",value:this.customer.fullNameOther,name:"fullNameOther","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"dfbe5775950a80cb5a549a9b3ba3e1fe6472f250",labelTag:"other_name",labelText:"Other Name",value:this.customer.otherPlantName,name:"otherPlantName","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"9448f638e2572ab6cefdb51484b0235eacb93940",labelTag:"other_name",labelText:"Other Local Name",value:this.customer.otherPlantNameOther,name:"otherPlantNameOther","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),t("app-form-item",{key:"6527545edbbeb28aaa1d0d3624cc508775d0ec9c",labelTag:"short_name",labelText:"Short Name",value:this.customer.shortName,name:"shortName","input-type":"text",onFormItemChanged:e=>this.handleChange(e),validator:["required"]}),this.customer.group.length==0?t("ion-item",{lines:"none"},t("ion-label",null,t("h2",null,t("my-transl",{tag:"add_customer_group",text:"Add Customer Group"}))),t("ion-button",{onClick:()=>this.editOwner(true),slot:"end"},"+")):undefined,this.customer.group.map(((e,a)=>t("ion-item",{lines:"none"},t("ion-label",null,a==0?t("ion-note",null,t("my-transl",{tag:"customer_group",text:"Customer Group"})):undefined,t("h2",null,e.groupName+" ["+e.groupOwnershipPerc+"%]")),a==this.customer.group.length-1?t("ion-button",{onClick:()=>this.editOwner(true),slot:"end"},"+"):undefined,t("ion-button",{slot:"end","icon-only":true,color:"danger",fill:"clear",onClick:()=>{this.editOwner(true,a,true)}},t("ion-icon",{name:"trash"})),t("ion-button",{slot:"end","icon-only":true,fill:"clear",onClick:()=>{this.editOwner(true,a)}},t("ion-icon",{name:"create"}))))),t("ion-item",{key:"e8576da08f6b193819b266ff3a5f89eb4f464fa3",lines:"none"},t("ion-label",{key:"3afea2ac084ede4d34cc7fdad8b48eaa14f9a72f"},t("ion-note",{key:"12a4d8e03cafabf6222eaf062cbaa2c58ba062a2"},t("my-transl",{key:"f34bbc08cb94e32460f38f8a6eb2b88fa9f1281f",tag:"customer_owner",text:"Customer Owner"})),t("h2",{key:"4fd2b85734e4246dbd9a6fce7532183ccbb93b28"},this.customer.owner.groupName)),t("ion-button",{key:"0ea77317f1dc07954de5d49755730b970fd9ec6b",slot:"end","icon-only":true,fill:"clear",onClick:()=>{this.editOwner(false)}},t("ion-icon",{key:"2dd35aca023bb18f4515388af41bc35f655ecc39",name:"create"}))),t("app-customer-plant-production",{key:"8c81ff9cab01ce49fcfb2b2a7d171b4b386c5482",customer:this.customer,editable:true})),this.customerId?t("ion-footer",{class:"ion-no-border"},t("ion-toolbar",null,t("ion-button",{expand:"block",fill:"outline",color:"danger",onClick:()=>this.deleteCustomer()},t("ion-icon",{slot:"start",name:"trash"}),t("my-transl",{tag:"delete",text:"Delete",isLabel:true})))):undefined),t("swiper-slide",{key:"490a938b80474e055939826b5546d890b1caa32e",class:"swiper-slide"},t("div",{key:"ce62091ee91742f5e4f7d8ab380f5b0d869688cd"},t("ion-toolbar",{key:"6b83fa624a3edc4a480aba9fb8900353958114e7"},t("ion-segment",{key:"c8dd892f8551f206482f869065f7ee2646f8e20e",mode:"ios",scrollable:true,onIonChange:e=>this.locationTypeSegmentChanged(e),value:this.locationTypeSegment},this.customer.locations.map(((e,a)=>t("ion-segment-button",{value:a,layout:"icon-start"},t("ion-label",null,l.getLocationsTypes(e.type)[0].locationName)))),t("ion-segment-button",{key:"40f420c381fe4220a79bf5d690a2007b419b215d",value:"add",onClick:()=>this.addLocation(),layout:"icon-start"},t("ion-label",{key:"bff17696e5ac3a9a819a5eb8bcb9c448beb11bc4"},"+")))),this.customer.locations.map(((e,a)=>t("div",null,this.locationTypeSegment==a?t("div",null,t("app-location",{locations:l.getLocationsTypes(),location:e,slider:this.slider,onLocationSelected:()=>this.updateLocation(),onLocationDeleted:()=>this.deleteLocation(a)})):undefined))))),t("swiper-slide",{key:"232a972bd4bc5e64223dd5069767a1b397d80a7f",class:"swiper-slide"},t("ion-grid",{key:"b8ce6c37d0fcb2d521c211305a19bd2de33fc7d6"},t("ion-row",{key:"bd368bdd2f879c4279df8c7027c0a5f806bd02be"},t("ion-col",{key:"0f7cf480a19dcb822f1af60566efd3462d664266"},t("ion-button",{key:"3b550804b9b22996b631d23c3c3e265b5fd8d3b1",color:C.getAppColor(),onClick:()=>this.editOperatingCondition("EAF"),expand:"block"},t("ion-icon",{key:"85e90950fcda6c34be87b95d3456ac0bb0b12f7c",name:"add"}),t("ion-label",{key:"f4f4773e040d447b758779b90c28c31ea6e94c01"},"EAF"))),t("ion-col",{key:"240c3245c66dd392122d89e904a3bfaad5eea2a1"},t("ion-button",{key:"1dadbe8fb48304d1cbcca3b1a5cd50ba488eca54",color:C.getAppColor(),onClick:()=>this.editOperatingCondition("LF"),expand:"block"},t("ion-icon",{key:"6d56958d8bb0f045ce8683a2a759d11b064af5e9",name:"add"}),t("ion-label",{key:"068fc08311b051ee6e46f3ae061e2d0b6cd0ba33"},"LF"))),t("ion-col",{key:"e55d6481ef739a59ca70d4633dead47e7a19b724"},t("ion-button",{key:"64c90073cab2568c1af7b1ad86b4722b424578c2",color:C.getAppColor(),onClick:()=>this.editOperatingCondition("CCM"),expand:"block"},t("ion-icon",{key:"82e5422a06adcad0b48c05fff02fe4c3b4d3ac04",name:"add"}),t("ion-label",{key:"91e1a86b7a4afcfcd5a2e94609df31f3dd225ce4"},"CCM"))))),t("ion-list",{key:"f9a2da85eca34eee3ce6f4e76bf29797007e7abf"},t("ion-item-divider",{key:"3e3c441e9b712d2243aecce025aab5bed2fcc52f"},"EAF"),this.customer.conditions.EAF.map((e=>t("ion-item",{button:true,detail:true,onClick:()=>this.editOperatingCondition("EAF",e)},t("ion-label",null,new Date(e.date).toLocaleDateString())))),t("ion-item-divider",{key:"36c0fa2381bcbd6d1f68146ae3ea8490211a1bf2"},"LF"),this.customer.conditions.LF.map((e=>t("ion-item",{button:true,detail:true,onClick:()=>this.editOperatingCondition("EAF",e)},t("ion-label",null,new Date(e.date).toLocaleDateString())))),t("ion-item-divider",{key:"8a27d848c3030b04472bc67eaaed3b57b325e717"},"CCM"),this.customer.conditions.CCM.map((e=>t("ion-item",null,t("ion-label",null,new Date(e.date).toLocaleDateString()))))))))),t("app-modal-footer",{key:"1dc67234a6bdf3931103cdf3a5823825cde31df7",color:C.getAppColor(),disableSave:!this.validCustomer,onCancelEmit:()=>this.cancel(),onSaveEmit:()=>this.save()}))}get el(){return i(this)}};L.style=x;export{L as modal_customer_update};