import{r as e,h as s,f as t}from"./p-cbe60c68.js";import{F as i,a3 as a,i as o,C as r}from"./p-736235c6.js";import{T as c}from"./p-9a446c6a.js";import{S as d}from"./p-a75993af.js";import{E as l}from"./p-46038295.js";import"./p-c7ee7cfe.js";import{n as h}from"./p-5d4a8e1f.js";import"./p-1819cfda.js";import"./p-1af05547.js";import"./p-e9c4f463.js";import"./p-7ee16e8d.js";import"./p-694b8ade.js";import"./p-3647f076.js";import"./p-9c77ce6f.js";import"./p-ae1763fb.js";import"./p-c5936999.js";import"./p-6879854f.js";const p="page-customers{}";const n=p;const f=class{constructor(s){e(this,s);this.markers=[];this.customersList=[];this.filteredCustomersList=[];this.visibleCustomers=[];this.loading=true;this.titles=[{tag:"list",text:"List",disabled:false,badge:0},{tag:"map",text:"Map",disabled:false,badge:0}];this.slider=undefined;this.updateView=false}mapLoadingCompletedHandler(){this.mapElement?this.mapElement["triggerMapResize"]():undefined}componentWillLoad(){i.customersList$.subscribe((async e=>{this.updateList(e);this.loading=false;this.updateMarkers()}));this.createPopoverVisibleCustomers()}filterCustomers(e){this.filteredCustomersList=e.detail;this.updateMarkers()}updateMarkers(){this.markers=[];if(this.filteredCustomersList.length>0){this.filteredCustomersList.forEach((e=>{if(e.locations.length>0){e.locations.forEach((s=>{if(s&&s.position&&s.position.geopoint){const t={collection:r,id:e.id,displayName:e.fullName,position:s.position,latitude:s.position.geopoint.latitude,longitude:s.position.geopoint.longitude,icon:{type:"ionicon",name:"location",color:"secondary",size:"small"},clickFn:()=>i.presentCustomerDetails(e.id)};this.markers.push(t)}}))}}));this.titles[0].badge=this.markers.length;this.updateView=!this.updateView;if(this.markers.length>0)this.loadMap()}}componentDidLoad(){this.slider=new d(".slider-customers-map",{speed:400,spaceBetween:100,allowTouchMove:false,autoHeight:true,on:{slideChange:()=>{this.slider?this.slider.updateAutoHeight():null}}});if(this.markers.length>0)this.loadMap();this.searchToolbar=this.el.querySelector("#searchToolbar");this.updateList(this.customersList)}updateList(e){this.customersList=e;this.searchToolbar?this.searchToolbar.forceFilter(e):undefined;this.updateSlider()}async loadMap(){await customElements.whenDefined("app-map");this.mapElement=this.el.querySelector("#map");this.updateMap(true);this.updateSlider()}updateMap(e=false){if(this.mapElement){const s=this.el.querySelector("#map-container");s.setAttribute("style","height: "+(a(null)-40)+"px");setTimeout((()=>{this.mapElement.triggerMapResize();e?this.mapElement.fitToBounds(this.markers):undefined}))}}mapBoundsChanged(e){const s=e.detail;this.visibleCustomers=[];this.filteredCustomersList.forEach((e=>{var t=e.getLngLat();t.map((t=>{if(s.contains(t)){this.visibleCustomers.push(e)}}))}));this.titles[1].badge=this.visibleCustomers.length;this.popoverVisibleCustomers.componentProps["selectOptions"]=this.visibleCustomers;this.updateView=!this.updateView}async createPopoverVisibleCustomers(){this.popoverVisibleCustomers=await h.create({component:"popover-select-search",componentProps:{selectOptions:this.visibleCustomers,selectValueText:["fullName"],selectValueId:"id",placeholder:"customer"},trigger:"hover-trigger",triggerAction:"hover",translucent:true,showBackdrop:false});this.popoverVisibleCustomers.addEventListener("mouseleave",(()=>{this.popoverVisibleCustomers.dismiss()}));this.popoverVisibleCustomers.onDidDismiss().then((e=>{if(e&&e.data){i.presentCustomerDetails(e.data.id)}else{this.createPopoverVisibleCustomers()}}))}addCustomer(){i.presentCustomerUpdate()}updateSlider(){this.updateView=!this.updateView;setTimeout((()=>{this.updateMap();this.slider?this.slider.update():undefined}),100)}render(){return[s("ion-header",{key:"c5c19c293c9eebc8e504679bf845d991126cdbf8"},s("app-navbar",{key:"cd72f70f3705fcbe54a6be7e375a7a80788eaef4",tag:"customers",text:"Customers",color:l.getAppColor()}),s("app-search-toolbar",{key:"fa870660b23cdd493a201e6ce13b100347c07790",id:"searchToolbar",searchTitle:"customers",list:this.customersList,orderFields:["fullName"],color:l.getAppColor(),placeholder:"Search by name",filterBy:["fullName"],onFilteredList:e=>this.filterCustomers(e)}),s("app-header-segment-toolbar",{key:"6033282a4951015b1ad602c7ba005c7e8336497f",color:l.getAppColor(),swiper:this.slider,titles:this.titles,updateBadge:this.updateView,noHeader:true})),s("ion-content",{key:"2a00c582b78e313a2e5353ce3eb1e3ca0fd55344",class:"slides"},c.isCustomerDBAdmin()?s("ion-fab",{vertical:"top",horizontal:"end",slot:"fixed",edge:true},s("ion-fab-button",{size:"small",onClick:()=>this.addCustomer(),color:l.getAppColor()},s("ion-icon",{name:"add"}))):undefined,s("swiper-container",{key:"c7bed370d5fdccbe1df6c4fa613b581098455f1e",class:"slider-customers-map swiper"},s("swiper-wrapper",{key:"e3b66e94fef1d98f9091909cc95652bcf07800eb",class:"swiper-wrapper"},s("swiper-slide",{key:"696fdbdc32e64709a2b846e7ed956a8371f9d24d",class:"swiper-slide"},s("app-infinite-scroll",{key:"f7c27eb5ad2bcb479f142467c8b3aa361f43c724",list:this.filteredCustomersList,loading:this.loading,showFields:["fullName"],orderBy:["fullName"],returnField:"id",icon:o.getMapDocs(r).icon.name,onItemClicked:e=>i.presentCustomerDetails(e.detail),onListChanged:()=>{this.updateSlider()}})),s("swiper-slide",{key:"eb73aa39d0bebdf51ddadcd00cade5a7ad9f2aed",class:"swiper-slide"},s("div",{key:"cd0e33c7faae9a2abc017af7d699c35a9d31bdb9",id:"map-container"},s("app-map",{key:"7666c1bb67d75cce22c1c533df5441def73c7ae8",id:"map",pageId:"customers-list",markersAsFeature:true,markers:this.markers,onEmitMapBounds:e=>this.mapBoundsChanged(e)})),s("ion-fab",{key:"4c5391a58714b8ee57ba4d582beb775a0bf55558",vertical:"top",horizontal:"start",slot:"fixed"},s("ion-fab-button",{key:"85a9c3dec448fd96d5a21eb9d6504e959e125610",color:"trasteel",id:"hover-trigger"},s("ion-badge",{key:"0c8e3374cf136d1ca28d304e3eb3d85e0d378d4f",color:"trasteel"},this.titles[1].badge)))))))]}get el(){return t(this)}};f.style=n;export{f as page_customers};