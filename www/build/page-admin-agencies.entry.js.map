{"file":"page-admin-agencies.entry.esm.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAM,oBAAoB,GAAG,uDAAuD;;MCqBvE,iBAAiB;;;;4CAI6B,EAAE;yBAEtC,KAAK;0BACJ,IAAI;;IAE1B,iBAAiB;QACf,IAAI,CAAC,SAAS,GAAG,WAAW,CAAC,SAAS,CAAC;QACvC,IAAI,CAAC,SAAS,GAAG,aAAa,CAAC,kBAAkB,CAAC,SAAS,CAAC,CAAC,KAAK;YAChE,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;YACnB,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,cAAc,CAAC,CAAC,OAAO,CAAC,CAAC,QAAQ;;gBAEjD,IACE,IAAI,CAAC,SAAS,CAAC,YAAY,EAAE;oBAC7B,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,QAAQ,CAAC,QAAQ,CAAC,WAAW,EAAE,GAAG,QAAQ,CAAC,EAChE;oBACA,MAAM,MAAM,GAAG,KAAK,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;oBAC9C,MAAM,CAAC,EAAE,GAAG,QAAQ,CAAC;oBACrB,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;iBAC5B;aACF,CAAC,CAAC;YACH,IAAI,CAAC,IAAI,CAAC,cAAc;gBACtB,IAAI,CAAC,cAAc,GAAGA,wBAAS,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;YACpD,IAAI,CAAC,yBAAyB,EAAE,CAAC;SAClC,CAAC,CAAC;KACJ;IAED,yBAAyB;QACvB,IAAI,CAAC,4BAA4B,GAAG,EAAE,CAAC;QACvC,MAAM,KAAK,GAAG,EAAE,CAAC;QACjB,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,cAAc,CAAC,cAAc,CAAC,CAAC,GAAG,CAAC,CAAC,GAAG;YACtD,IAAI,IAAI,GAAG,IAAI,CAAC,cAAc,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC;YACnD,IAAI,CAAC,EAAE,GAAG,GAAG,CAAC;YACd,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;SAClB,CAAC,CAAC;QACH,IAAI,CAAC,4BAA4B,GAAGC,sBAAO,CAAC,KAAK,EAAE,OAAO,CAAC,CAAC;KAC7D;IAED,oBAAoB;QAClB,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE,CAAC;KAC9B;IAED,YAAY,CAAC,QAAQ;QACnB,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACvB,IAAI,CAAC,cAAc,GAAGD,wBAAS,CAC7B,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,MAAM,KAAK,MAAM,CAAC,EAAE,IAAI,QAAQ,CAAC,CACtD,CAAC;QACF,IAAI,CAAC,yBAAyB,EAAE,CAAC;KAClC;IAED,YAAY,CAAC,EAAE;QACb,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,IAAI,CAAC,cAAc,CAAC,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC;KACvD;IAED,MAAM,qBAAqB,CAAC,OAAO;QACjC,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,MAAM,KAAK,GAAGA,wBAAS,CAAC,IAAI,CAAC,4BAA4B,CAAC,CAAC;QAC3D,MAAM,QAAQ,GAAG,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QACzD,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE,EAAE,CAAC,EAAE,QAAQ,CAAC,CAAC;QAC7C,KAAK,CAAC,OAAO,CAAC,CAAC,IAAI,EAAE,KAAK;YACxB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;SACpB,CAAC,CAAC;QACH,OAAO,CAAC,MAAM,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;QAC/B,IAAI,CAAC,4BAA4B,GAAGC,sBAAO,CAAC,KAAK,EAAE,OAAO,CAAC,CAAC;KAC7D;IAED,MAAM,iBAAiB,CAAC,GAAI;QAC1B,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,IAAI,IAAI,GAAG,IAAI,CAAC;QAChB,IAAI,GAAG,KAAK,SAAS,EAAE;YACrB,IAAI,GAAG;gBACL,EAAE,EAAE,IAAI;gBACR,QAAQ,EAAE,EAAE;gBACZ,IAAI,EAAE,EAAE;gBACR,KAAK,EAAE,IAAI,CAAC,4BAA4B;sBACpC,IAAI,CAAC,4BAA4B,CAAC,MAAM;sBACxC,CAAC;gBACL,KAAK,EAAE,EAAE;aACV,CAAC;SACH;aAAM;YACL,IAAI,GAAGD,wBAAS,CAAC,IAAI,CAAC,4BAA4B,CAAC,GAAG,CAAC,CAAC,CAAC;SAC1D;QAED,MAAM,KAAK,GAAG,MAAM,aAAa,CAAC,SAAS,CACzC,iCAAiC,EACjC;YACE,QAAQ,EAAE,IAAI,CAAC,cAAc,CAAC,EAAE;YAChC,iBAAiB,EAAE,IAAI;SACxB,CACF,CAAC;QACF,KAAK,CAAC,YAAY,EAAE,CAAC,IAAI,CAAC,CAAC,WAAW;YACpC,MAAM,IAAI,GAAG,WAAW,CAAC,IAAqB,CAAC;YAC/C,IAAI,IAAI,EAAE;gBACR,IAAI,GAAG,KAAK,SAAS,EAAE;oBACrB,IAAI,CAAC,4BAA4B,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;iBAC9C;qBAAM;oBACL,IAAI,CAAC,4BAA4B,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC;iBAC/C;gBACD,IAAI,CAAC,UAAU,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC;aACpC;SACF,CAAC,CAAC;KACJ;IAED,eAAe,CAAC,EAAE;QAChB,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,MAAM,SAAS,GAAG,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC;QACjC,MAAM,GAAG,GAAG,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC;QAC1B,IAAI,SAAS,IAAI,OAAO,EAAE;YACxB,IAAI,CAAC,cAAc,CAAC,QAAQ,GAAG,GAAG,CAAC;SACpC;aAAM;YACL,IAAI,CAAC,cAAc,CAAC,QAAQ,GAAG,GAAG,CAAC;SACpC;KACF;IAED,MAAM,IAAI;;QAER,IAAI,CAAC,cAAc,CAAC,cAAc,GAAG,EAAE,CAAC;QACxC,IAAI,CAAC,4BAA4B,CAAC,GAAG,CAAC,CAAC,IAAI;YACzC,IAAI,CAAC,cAAc,CAAC,cAAc,CAAC,IAAI,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC;SACpD,CAAC,CAAC;QACH,MAAM,GAAG,GAAG,MAAM,6BAA6B,CAAC,kBAAkB,CAChE,IAAI,CAAC,cAAc,CAAC,EAAE,EACtB,IAAI,CAAC,cAAc,CACpB,CAAC;QACF,IAAI,GAAG,EAAE;YACP,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;SACxB;KACF;IAED,MAAM;QACJ,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACvB,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,cAAc,CAAC,EAAE,CAAC,CAAC;KAC3C;IAED,MAAM;QACJ,OAAO;YACL,mEAAY,KAAK,EAAC,OAAO,IACvB,yEACE,IAAI,EAAE;oBACJ,UAAU,EAAE,gBAAgB;oBAC5B,EAAE,EAAE,IAAI,CAAC,cAAc,CAAC,EAAE;oBAC1B,QAAQ,EAAE,IAAI,CAAC,cAAc,CAAC,QAAQ;oBACtC,QAAQ,EAAE,IAAI,CAAC,cAAc,CAAC,QAAQ;iBACvC,EACD,eAAe,EAAE,CAAC,EAAE,KAAK,IAAI,CAAC,eAAe,CAAC,EAAE,CAAC,GAC/B,CACT;YACb,sEACE,gEACE,QAAQ,EAAC,KAAK,EACd,UAAU,EAAC,OAAO,EAClB,IAAI,EAAC,OAAO,EACZ,KAAK,EAAE,EAAC,SAAS,EAAE,wBAAwB,CAAC,CAAC,CAAC,EAAC,IAE/C,wEAAiB,KAAK,EAAC,UAAU,GAAG,CAC5B,EACV,mEACG,IAAI,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,IACvB,oBACE,4CAA2C,EAC3C,kBACE,KAAK,EAAE,IAAI,CAAC,cAAc,CAAC,EAAE,EAC7B,WAAW,EAAE,CAAC,EAAE,KAAK,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC,EACvD,SAAS,EAAC,SAAS,IAElB,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,MAAM,MACxB,yBAAmB,KAAK,EAAE,MAAM,CAAC,EAAE,IAChC,MAAM,CAAC,IAAI,CACM,CACrB,CAAC,CACS,CACJ,IACT,SAAS,EACb,mFACY,MAAM,gBACL,MAAM,EACjB,KAAK,EAAE,IAAI,CAAC,cAAc,CAAC,IAAI,EAC/B,IAAI,EAAC,MAAM,gBACA,MAAM,EACjB,iBAAiB,EAAE,CAAC,EAAE,KAAK,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,EAChD,SAAS,EAAE,CAAC,UAAU,CAAC,GACR,EACjB,mFACY,SAAS,gBACR,SAAS,EACpB,KAAK,EAAE,IAAI,CAAC,cAAc,CAAC,OAAO,EAClC,IAAI,EAAC,SAAS,gBACH,MAAM,EACjB,iBAAiB,EAAE,CAAC,EAAE,KAAK,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,EAChD,SAAS,EAAE,CAAC,UAAU,CAAC,GACR,CACR,EACX,mEACE,0EACE,oEACE,kEAAW,GAAG,EAAC,gBAAgB,EAAC,IAAI,EAAC,gBAAgB,GAAG,CAC9C,EACZ,sFAAsB,OAAO,EAAE,MAAM,IAAI,CAAC,iBAAiB,EAAE,IAC3D,iEAAU,IAAI,EAAC,oBAAoB,GAAY,CACpC,CACG,EAClB,0EACE,QAAQ,EAAE,KAAK,EACf,gBAAgB,EAAE,CAAC,EAAE,KAAK,IAAI,CAAC,qBAAqB,CAAC,EAAE,CAAC,IAEvD,IAAI,CAAC,4BAA4B,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,CAAC,MAC7C,oBACG,IAAI,CAAC,QAAQ,IACZ,kBAAY,IAAI,EAAC,OAAO,IACtB,WAAK,GAAG,EAAE,IAAI,CAAC,QAAQ,GAAI,CAChB,IACX,SAAS,EACb,mBAAa,IAAI,EAAC,KAAK,GAAe,EACtC,qBACG,IAAI,CAAC,KAAK,GAAG,CAAC,QAAI,IAAI,CAAC,IAAI,CAClB,EACZ,qCAEE,IAAI,EAAC,OAAO,EACZ,OAAO,EAAE,MAAM,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC,IAExC,gBAAU,IAAI,EAAC,gBAAgB,GAAY,CAChC,CACJ,CACZ,CAAC,CACgB,CACX,CACC;YACd,IAAI,CAAC,SAAS,IACZ,wBACE,UAAU,EAAE,MAAM,IAAI,CAAC,IAAI,EAAE,EAC7B,YAAY,EAAE,MAAM,IAAI,CAAC,MAAM,EAAE,GACjC,IACA,SAAS;SACd,CAAC;KACH;;;;;;","names":["cloneDeep","orderBy"],"sources":["src/components/udive/pages/admin/page-admin-agencies/page-admin-agencies.scss?tag=page-admin-agencies","src/components/udive/pages/admin/page-admin-agencies/page-admin-agencies.tsx"],"sourcesContent":["page-admin-agencies {\n  .cover {\n    height: var(--coverHeight);\n  }\n}\n","import {Component, h, State} from \"@stencil/core\";\nimport {UserService} from \"../../../../../services/common/user\";\nimport {UserRoles} from \"../../../../../interfaces/common/user/user-roles\";\nimport {\n  SystemService,\n  SYSTEMCOLLECTION,\n} from \"../../../../../services/common/system\";\nimport {Subscription} from \"rxjs\";\nimport {\n  Agency,\n  Certification,\n} from \"../../../../../interfaces/udive/diving-class/divingClass\";\nimport {cloneDeep, orderBy} from \"lodash\";\nimport {RouterService} from \"../../../../../services/common/router\";\nimport {fabButtonTopMarginString} from \"../../../../../helpers/utils\";\nimport {CallableFunctionsUdiveService} from \"../../../../../services/udive/callableFunctions\";\n\n@Component({\n  tag: \"page-admin-agencies\",\n  styleUrl: \"page-admin-agencies.scss\",\n})\nexport class PageAdminAgencies {\n  systemSub: Subscription;\n  userRoles: UserRoles;\n  @State() selectedAgency: Agency;\n  @State() selectedAgencyCertifications: Certification[] = [];\n  agencies: Agency[];\n  @State() isUpdated = false;\n  @State() updateView = true;\n\n  componentWillLoad() {\n    this.userRoles = UserService.userRoles;\n    this.systemSub = SystemService.systemPreferences$.subscribe((prefs) => {\n      this.agencies = [];\n      Object.keys(prefs.divingAgencies).forEach((agencyId) => {\n        //set only agencies allowed to this user\n        if (\n          this.userRoles.isSuperAdmin() ||\n          this.userRoles.roles.includes(agencyId.toLowerCase() + \"-admin\")\n        ) {\n          const agency = prefs.divingAgencies[agencyId];\n          agency.id = agencyId;\n          this.agencies.push(agency);\n        }\n      });\n      if (!this.selectedAgency)\n        this.selectedAgency = cloneDeep(this.agencies[0]);\n      this.createCertificationsArray();\n    });\n  }\n\n  createCertificationsArray() {\n    this.selectedAgencyCertifications = [];\n    const certs = [];\n    Object.keys(this.selectedAgency.certifications).map((key) => {\n      let cert = this.selectedAgency.certifications[key];\n      cert.id = key;\n      certs.push(cert);\n    });\n    this.selectedAgencyCertifications = orderBy(certs, \"order\");\n  }\n\n  disconnectedCallback() {\n    this.systemSub.unsubscribe();\n  }\n\n  updateAgency(agencyId) {\n    this.isUpdated = false;\n    this.selectedAgency = cloneDeep(\n      this.agencies.find((agency) => agency.id == agencyId)\n    );\n    this.createCertificationsArray();\n  }\n\n  handleChange(ev) {\n    this.isUpdated = true;\n    this.selectedAgency[ev.detail.name] = ev.detail.value;\n  }\n\n  async reorderCertifications(reorder) {\n    this.isUpdated = true;\n    const certs = cloneDeep(this.selectedAgencyCertifications);\n    const itemMove = certs.splice(reorder.detail.from, 1)[0];\n    certs.splice(reorder.detail.to, 0, itemMove);\n    certs.forEach((cert, order) => {\n      cert.order = order;\n    });\n    reorder.detail.complete(certs);\n    this.selectedAgencyCertifications = orderBy(certs, \"order\");\n  }\n\n  async editCertification(key?) {\n    this.isUpdated = true;\n    let cert = null;\n    if (key === undefined) {\n      cert = {\n        id: null,\n        maxDepth: 20,\n        name: \"\",\n        order: this.selectedAgencyCertifications\n          ? this.selectedAgencyCertifications.length\n          : 0,\n        group: \"\",\n      };\n    } else {\n      cert = cloneDeep(this.selectedAgencyCertifications[key]);\n    }\n\n    const modal = await RouterService.openModal(\n      \"modal-dive-certification-update\",\n      {\n        agencyId: this.selectedAgency.id,\n        diveCertification: cert,\n      }\n    );\n    modal.onDidDismiss().then((updatedCert) => {\n      const cert = updatedCert.data as Certification;\n      if (cert) {\n        if (key === undefined) {\n          this.selectedAgencyCertifications.push(cert);\n        } else {\n          this.selectedAgencyCertifications[key] = cert;\n        }\n        this.updateView = !this.updateView;\n      }\n    });\n  }\n\n  updateImageUrls(ev) {\n    this.isUpdated = true;\n    const imageType = ev.detail.type;\n    const url = ev.detail.url;\n    if (imageType == \"photo\") {\n      this.selectedAgency.photoURL = url;\n    } else {\n      this.selectedAgency.coverURL = url;\n    }\n  }\n\n  async save() {\n    //update certifications\n    this.selectedAgency.certifications = {};\n    this.selectedAgencyCertifications.map((cert) => {\n      this.selectedAgency.certifications[cert.id] = cert;\n    });\n    const res = await CallableFunctionsUdiveService.updateDivingAgency(\n      this.selectedAgency.id,\n      this.selectedAgency\n    );\n    if (res) {\n      this.isUpdated = false;\n    }\n  }\n\n  cancel() {\n    this.isUpdated = false;\n    this.updateAgency(this.selectedAgency.id);\n  }\n\n  render() {\n    return [\n      <ion-header class=\"cover\">\n        <app-upload-cover\n          item={{\n            collection: SYSTEMCOLLECTION,\n            id: this.selectedAgency.id,\n            photoURL: this.selectedAgency.photoURL,\n            coverURL: this.selectedAgency.coverURL,\n          }}\n          onCoverUploaded={(ev) => this.updateImageUrls(ev)}\n        ></app-upload-cover>\n      </ion-header>,\n      <ion-content>\n        <ion-fab\n          vertical=\"top\"\n          horizontal=\"start\"\n          slot=\"fixed\"\n          style={{marginTop: fabButtonTopMarginString(0)}}\n        >\n          <ion-menu-button class=\"fab-icon\" />\n        </ion-fab>\n        <ion-list>\n          {this.agencies.length > 0 ? (\n            <ion-item>\n              <ion-label>Select Diving Agency</ion-label>\n              <ion-select\n                value={this.selectedAgency.id}\n                onIonChange={(ev) => this.updateAgency(ev.detail.value)}\n                interface=\"popover\"\n              >\n                {this.agencies.map((agency) => (\n                  <ion-select-option value={agency.id}>\n                    {agency.name}\n                  </ion-select-option>\n                ))}\n              </ion-select>\n            </ion-item>\n          ) : undefined}\n          <app-form-item\n            label-tag=\"name\"\n            label-text=\"Name\"\n            value={this.selectedAgency.name}\n            name=\"name\"\n            input-type=\"text\"\n            onFormItemChanged={(ev) => this.handleChange(ev)}\n            validator={[\"required\"]}\n          ></app-form-item>\n          <app-form-item\n            label-tag=\"website\"\n            label-text=\"Website\"\n            value={this.selectedAgency.website}\n            name=\"website\"\n            input-type=\"text\"\n            onFormItemChanged={(ev) => this.handleChange(ev)}\n            validator={[\"required\"]}\n          ></app-form-item>\n        </ion-list>\n        <ion-list>\n          <ion-list-header>\n            <ion-label>\n              <my-transl tag=\"certifications\" text=\"Certifications\" />\n            </ion-label>\n            <ion-button icon-only onClick={() => this.editCertification()}>\n              <ion-icon name=\"add-circle-outline\"></ion-icon>\n            </ion-button>\n          </ion-list-header>\n          <ion-reorder-group\n            disabled={false}\n            onIonItemReorder={(ev) => this.reorderCertifications(ev)}\n          >\n            {this.selectedAgencyCertifications.map((cert, i) => (\n              <ion-item>\n                {cert.photoURL ? (\n                  <ion-avatar slot=\"start\">\n                    <img src={cert.photoURL} />\n                  </ion-avatar>\n                ) : undefined}\n                <ion-reorder slot=\"end\"></ion-reorder>\n                <ion-label>\n                  {cert.order + 1}. {cert.name}\n                </ion-label>\n                <ion-button\n                  icon-only\n                  fill=\"clear\"\n                  onClick={() => this.editCertification(i)}\n                >\n                  <ion-icon name=\"create-outline\"></ion-icon>\n                </ion-button>\n              </ion-item>\n            ))}\n          </ion-reorder-group>\n        </ion-list>\n      </ion-content>,\n      this.isUpdated ? (\n        <app-modal-footer\n          onSaveEmit={() => this.save()}\n          onCancelEmit={() => this.cancel()}\n        />\n      ) : undefined,\n    ];\n  }\n}\n"],"version":3}